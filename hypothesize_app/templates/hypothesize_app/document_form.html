<head>
    {% load staticfiles %}
    <link rel="stylesheet" type="text/css" href="{% static "css/skin.css" %}"/>
    <script src="{% static "js/jquery-2.1.4.js" %}"></script>
    <script src="{% static "js/jquery.a-tools-1.4.1.js" %}"></script>
    <script src="{% static "js/jquery.asuggest.js" %}"></script>
    <script>
    function fetch_document_metadata(document_title) {
        $.ajax({
            url: "{% url 'hypothesize_app:ajax_document_autofiller' %}",
            type: "GET",
            data: {
                'title': document_title
            },

            success: function(json){
                $('#autofill_message').html('search completed');

                // fill in results

                $('#id_title').val(json['title']);
                $('#id_publication').val(json['publication']);
                $('#id_year').val(json['year']);
                $('#id_author_text').val(json['author_text']);
                $('#id_crossref').val(json['crossref']);

            },

            failure: function(json){
                $('#autofill_message').html(json['error_message']);
            }
        });
    }

    $(document).ready(function(){

        //var suggests = ['elephant', 'rhino', 'elephino'];
        var suggests_documents = {{ document_key_list | safe }};
        $.fn.asuggest.defaults.delimiters = " ";
        $.fn.asuggest.defaults.minChunkSize = 1;

        $("#id_linked_document_text").asuggest(suggests_documents);

        var suggests_authors = {{ author_name_list | safe }};
        $("#id_author_text").asuggest(suggests_authors);

        var suggests_publication = {{ publication_name_list | safe }};
        $("#id_publication").asuggest(suggests_publication);

        $(document).on('click', '#autofill_button', function() {
            event.preventDefault();
            var fetch_message = 'searching...';
            $('#autofill_message').html(fetch_message);
            fetch_document_metadata($('#id_title').val());
        });
    });
    </script>

    <title>
        {% if document %}
            EDIT: {{ document.title }}
        {% else %}
            add new document
        {% endif %}
    </title>
</head>

<form action="" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="submit" value="Save" />(<a href="{% url 'hypothesize_app:document_search' %}">return to search</a>)
    <br /><br />
    title {{ form.title }} <br />
    (<a id="autofill_button" href="#">attempt to autofill from title using CrossRef</a>)
    <span id="autofill_message"></span><br />
    publication {{ form.publication }} <br />
    year {{ form.year }} <br />
    file {{ form.file }} <br />
    webpage {{ form.web_link }} <br />
    authors <br /> {{ form.author_text }} <br />
    abstract <br /> {{ form.abstract }} <br />
    CrossRef metadata string <br /> {{ form.crossref }} <br />
    downstream documents <br /> {{ form.linked_document_text }}
</form>

{% if include_delete %}

<br />

<a href="{% url 'hypothesize_app:document_delete' document.id %}">delete this document</a>

{% endif %}